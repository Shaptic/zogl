function sum(e){var t=0;for(var n in e){t+=parseFloat(e[n])}return t}function log(){for(var e in arguments){console.log(arguments[e])}}WebGLDebugUtils=function(){function i(e){if(r==null){r={};for(var t in e){if(typeof e[t]=="number"){r[e[t]]=t}}}}function s(){if(r==null){throw"WebGLDebugUtils.init(ctx) not called"}}function o(e){s();return r[e]!==undefined}function u(e){s();var t=r[e];return t!==undefined?"gl."+t:"/*UNKNOWN WebGL ENUM*/ 0x"+e.toString(16)+""}function a(e,t,r,i){var s=n[e];if(s!==undefined){var s=s[t];if(s!==undefined){if(s[r]){return u(i)}}}if(i===null){return"null"}else if(i===undefined){return"undefined"}else{return i.toString()}}function f(e,t){var n="";var r=t.length;for(var i=0;i<r;++i){n+=(i==0?"":", ")+a(e,r,i,t[i])}return n}function l(e,t,n){e.__defineGetter__(n,function(){return t[n]});e.__defineSetter__(n,function(e){t[n]=e})}function c(e,t){var n=e[t];return function(){var t=n.apply(e,arguments);return t}}function h(e,n,r,s){function f(e,t){return function(){if(r){r(t,arguments)}var i=e[t].apply(e,arguments);var u=s.getError();if(u!=0){o[u]=true;n(u,t,arguments)}return i}}s=s||e;i(e);n=n||function(e,n,r){var i="";var s=r.length;for(var o=0;o<s;++o){i+=(o==0?"":", ")+a(n,s,o,r[o])}t("WebGL error "+u(e)+" in "+n+"("+i+")")};var o={};var c={};for(var p in e){if(typeof e[p]=="function"){if(p!="getExtension"){c[p]=f(e,p)}else{var d=f(e,p);c[p]=function(){var t=d.apply(e,arguments);return h(t,n,r,s)}}}else{l(c,e,p)}}c.getError=function(){for(var t in o){if(o.hasOwnProperty(t)){if(o[t]){o[t]=false;return t}}}return e.NO_ERROR};return c}function p(e){var t=e.getParameter(e.MAX_VERTEX_ATTRIBS);var n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n);for(var r=0;r<t;++r){e.disableVertexAttribArray(r);e.vertexAttribPointer(r,4,e.FLOAT,false,0,0);e.vertexAttrib1f(r,0)}e.deleteBuffer(n);var i=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(var r=0;r<i;++r){e.activeTexture(e.TEXTURE0+r);e.bindTexture(e.TEXTURE_CUBE_MAP,null);e.bindTexture(e.TEXTURE_2D,null)}e.activeTexture(e.TEXTURE0);e.useProgram(null);e.bindBuffer(e.ARRAY_BUFFER,null);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindRenderbuffer(e.RENDERBUFFER,null);e.disable(e.BLEND);e.disable(e.CULL_FACE);e.disable(e.DEPTH_TEST);e.disable(e.DITHER);e.disable(e.SCISSOR_TEST);e.blendColor(0,0,0,0);e.blendEquation(e.FUNC_ADD);e.blendFunc(e.ONE,e.ZERO);e.clearColor(0,0,0,0);e.clearDepth(1);e.clearStencil(-1);e.colorMask(true,true,true,true);e.cullFace(e.BACK);e.depthFunc(e.LESS);e.depthMask(true);e.depthRange(0,1);e.frontFace(e.CCW);e.hint(e.GENERATE_MIPMAP_HINT,e.DONT_CARE);e.lineWidth(1);e.pixelStorei(e.PACK_ALIGNMENT,4);e.pixelStorei(e.UNPACK_ALIGNMENT,4);e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,false);e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);if(e.UNPACK_COLORSPACE_CONVERSION_WEBGL){e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL)}e.polygonOffset(0,0);e.sampleCoverage(1,false);e.scissor(0,0,e.canvas.width,e.canvas.height);e.stencilFunc(e.ALWAYS,0,4294967295);e.stencilMask(4294967295);e.stencilOp(e.KEEP,e.KEEP,e.KEEP);e.viewport(0,0,e.canvas.width,e.canvas.height);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);while(e.getError());}function d(e){function m(e){if(typeof e=="function"){return e}else{return function(t){e.handleEvent(t)}}}function b(e){var t=e.addEventListener;e.addEventListener=function(n,r,i){switch(n){case"webglcontextlost":g(r);break;case"webglcontextrestored":y(r);break;default:t.apply(e,arguments)}}}function w(e){return e instanceof WebGLBuffer||e instanceof WebGLFramebuffer||e instanceof WebGLProgram||e instanceof WebGLRenderbuffer||e instanceof WebGLShader||e instanceof WebGLTexture}function E(e){for(var t=0;t<e.length;++t){var n=e[t];if(w(n)){return n.__webglDebugContextLostId__==s}}return true}function S(){var e=Object.keys(v);for(var t=0;t<e.length;++t){delete v[e]}}function x(){++c;if(!o){if(f==c){e.loseContext()}}}function T(e,t){var n=e[t];return function(){x();if(!o){var t=n.apply(e,arguments);return t}}}function N(){for(var e=0;e<a.length;++e){var n=a[e];if(n instanceof WebGLBuffer){t.deleteBuffer(n)}else if(n instanceof WebGLFramebuffer){t.deleteFramebuffer(n)}else if(n instanceof WebGLProgram){t.deleteProgram(n)}else if(n instanceof WebGLRenderbuffer){t.deleteRenderbuffer(n)}else if(n instanceof WebGLShader){t.deleteShader(n)}else if(n instanceof WebGLTexture){t.deleteTexture(n)}}}function C(e){return{statusMessage:e,preventDefault:function(){h=true}}}function k(e){for(var r in e){if(typeof e[r]=="function"){n[r]=T(e,r)}else{l(n,e,r)}}n.getError=function(){x();if(!o){var e;while(e=t.getError()){v[e]=true}}for(var e in v){if(v[e]){delete v[e];return e}}return n.NO_ERROR};var i=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"];for(var u=0;u<i.length;++u){var f=i[u];n[f]=function(t){return function(){x();if(o){return null}var n=t.apply(e,arguments);n.__webglDebugContextLostId__=s;a.push(n);return n}}(e[f])}var c=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(var u=0;u<c.length;++u){var f=c[u];n[f]=function(t){return function(){x();if(o){return null}return t.apply(e,arguments)}}(n[f])}var h=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(var u=0;u<h.length;++u){var f=h[u];n[f]=function(t){return function(){x();if(o){return false}return t.apply(e,arguments)}}(n[f])}n.checkFramebufferStatus=function(t){return function(){x();if(o){return n.FRAMEBUFFER_UNSUPPORTED}return t.apply(e,arguments)}}(n.checkFramebufferStatus);n.getAttribLocation=function(t){return function(){x();if(o){return-1}return t.apply(e,arguments)}}(n.getAttribLocation);n.getVertexAttribOffset=function(t){return function(){x();if(o){return 0}return t.apply(e,arguments)}}(n.getVertexAttribOffset);n.isContextLost=function(){return o};return n}var t;var n;var r=[];var i=[];var n={};var s=1;var o=false;var u=0;var a=[];var f=0;var c=0;var h=false;var d=0;var v={};e.getContext=function(r){return function(){var i=r.apply(e,arguments);if(i instanceof WebGLRenderingContext){if(i!=t){if(t){throw"got different context"}t=i;n=k(t)}return n}return i}}(e.getContext);var g=function(e){r.push(m(e))};var y=function(e){i.push(m(e))};b(e);e.loseContext=function(){if(!o){o=true;f=0;++s;while(t.getError());S();v[t.CONTEXT_LOST_WEBGL]=true;var n=C("context lost");var i=r.slice();setTimeout(function(){for(var t=0;t<i.length;++t){i[t](n)}if(d>=0){setTimeout(function(){e.restoreContext()},d)}},0)}};e.restoreContext=function(){if(o){if(i.length){setTimeout(function(){if(!h){throw"can not restore. webglcontestlost listener did not call event.preventDefault"}N();p(t);o=false;c=0;h=false;var e=i.slice();var n=C("context restored");for(var r=0;r<e.length;++r){e[r](n)}},0)}}};e.loseContextInNCalls=function(e){if(o){throw"You can not ask a lost contet to be lost"}f=c+e};e.getNumCalls=function(){return c};e.setRestoreTimeout=function(e){d=e};return e}var e=function(e){if(window.console&&window.console.log){window.console.log(e)}};var t=function(t){if(window.console&&window.console.error){window.console.error(t)}else{e(t)}};var n={enable:{1:{0:true}},disable:{1:{0:true}},getParameter:{1:{0:true}},drawArrays:{3:{0:true}},drawElements:{4:{0:true,2:true}},createShader:{1:{0:true}},getShaderParameter:{2:{1:true}},getProgramParameter:{2:{1:true}},getShaderPrecisionFormat:{2:{0:true,1:true}},getVertexAttrib:{2:{1:true}},vertexAttribPointer:{6:{2:true}},bindTexture:{2:{0:true}},activeTexture:{1:{0:true}},getTexParameter:{2:{0:true,1:true}},texParameterf:{3:{0:true,1:true}},texParameteri:{3:{0:true,1:true,2:true}},texImage2D:{9:{0:true,2:true,6:true,7:true},6:{0:true,2:true,3:true,4:true}},texSubImage2D:{9:{0:true,6:true,7:true},7:{0:true,4:true,5:true}},copyTexImage2D:{8:{0:true,2:true}},copyTexSubImage2D:{8:{0:true}},generateMipmap:{1:{0:true}},compressedTexImage2D:{7:{0:true,2:true}},compressedTexSubImage2D:{8:{0:true,6:true}},bindBuffer:{2:{0:true}},bufferData:{3:{0:true,2:true}},bufferSubData:{3:{0:true}},getBufferParameter:{2:{0:true,1:true}},pixelStorei:{2:{0:true,1:true}},readPixels:{7:{4:true,5:true}},bindRenderbuffer:{2:{0:true}},bindFramebuffer:{2:{0:true}},checkFramebufferStatus:{1:{0:true}},framebufferRenderbuffer:{4:{0:true,1:true,2:true}},framebufferTexture2D:{5:{0:true,1:true,2:true}},getFramebufferAttachmentParameter:{3:{0:true,1:true,2:true}},getRenderbufferParameter:{2:{0:true,1:true}},renderbufferStorage:{4:{0:true,1:true}},clear:{1:{0:true}},depthFunc:{1:{0:true}},blendFunc:{2:{0:true,1:true}},blendFuncSeparate:{4:{0:true,1:true,2:true,3:true}},blendEquation:{1:{0:true}},blendEquationSeparate:{2:{0:true,1:true}},stencilFunc:{3:{0:true}},stencilFuncSeparate:{4:{0:true,1:true}},stencilMaskSeparate:{2:{0:true}},stencilOp:{3:{0:true,1:true,2:true}},stencilOpSeparate:{4:{0:true,1:true,2:true,3:true}},cullFace:{1:{0:true}},frontFace:{1:{0:true}},drawArraysInstancedANGLE:{4:{0:true}},drawElementsInstancedANGLE:{5:{0:true,2:true}},blendEquationEXT:{1:{0:true}}};var r=null;return{init:i,mightBeEnum:o,glEnumToString:u,glFunctionArgToString:a,glFunctionArgsToString:f,makeDebugContext:h,makeLostContextSimulatingCanvas:d,resetToInitialState:p}}();glMatrixArrayType=typeof Float32Array!="undefined"?Float32Array:typeof WebGLFloatArray!="undefined"?WebGLFloatArray:Array;var vec3={};vec3.create=function(e){var t=new glMatrixArrayType(3);if(e){t[0]=e[0];t[1]=e[1];t[2]=e[2]}return t};vec3.set=function(e,t){t[0]=e[0];t[1]=e[1];t[2]=e[2];return t};vec3.add=function(e,t,n){if(!n||e==n){e[0]+=t[0];e[1]+=t[1];e[2]+=t[2];return e}n[0]=e[0]+t[0];n[1]=e[1]+t[1];n[2]=e[2]+t[2];return n};vec3.subtract=function(e,t,n){if(!n||e==n){e[0]-=t[0];e[1]-=t[1];e[2]-=t[2];return e}n[0]=e[0]-t[0];n[1]=e[1]-t[1];n[2]=e[2]-t[2];return n};vec3.negate=function(e,t){t||(t=e);t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];return t};vec3.scale=function(e,t,n){if(!n||e==n){e[0]*=t;e[1]*=t;e[2]*=t;return e}n[0]=e[0]*t;n[1]=e[1]*t;n[2]=e[2]*t;return n};vec3.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=Math.sqrt(n*n+r*r+i*i);if(s){if(s==1){t[0]=n;t[1]=r;t[2]=i;return t}}else{t[0]=0;t[1]=0;t[2]=0;return t}s=1/s;t[0]=n*s;t[1]=r*s;t[2]=i*s;return t};vec3.cross=function(e,t,n){n||(n=e);var r=e[0],i=e[1];e=e[2];var s=t[0],o=t[1];t=t[2];n[0]=i*t-e*o;n[1]=e*s-r*t;n[2]=r*o-i*s;return n};vec3.length=function(e){var t=e[0],n=e[1];e=e[2];return Math.sqrt(t*t+n*n+e*e)};vec3.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]};vec3.direction=function(e,t,n){n||(n=e);var r=e[0]-t[0],i=e[1]-t[1];e=e[2]-t[2];t=Math.sqrt(r*r+i*i+e*e);if(!t){n[0]=0;n[1]=0;n[2]=0;return n}t=1/t;n[0]=r*t;n[1]=i*t;n[2]=e*t;return n};vec3.lerp=function(e,t,n,r){r||(r=e);r[0]=e[0]+n*(t[0]-e[0]);r[1]=e[1]+n*(t[1]-e[1]);r[2]=e[2]+n*(t[2]-e[2]);return r};vec3.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"};var mat3={};mat3.create=function(e){var t=new glMatrixArrayType(9);if(e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9]}return t};mat3.set=function(e,t){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];return t};mat3.identity=function(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=0;e[7]=0;e[8]=1;return e};mat3.transpose=function(e,t){if(!t||e==t){var n=e[1],r=e[2],i=e[5];e[1]=e[3];e[2]=e[6];e[3]=n;e[5]=e[7];e[6]=r;e[7]=i;return e}t[0]=e[0];t[1]=e[3];t[2]=e[6];t[3]=e[1];t[4]=e[4];t[5]=e[7];t[6]=e[2];t[7]=e[5];t[8]=e[8];return t};mat3.toMat4=function(e,t){t||(t=mat4.create());t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=0;t[4]=e[3];t[5]=e[4];t[6]=e[5];t[7]=0;t[8]=e[6];t[9]=e[7];t[10]=e[8];t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t};mat3.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]"};var mat4={};mat4.create=function(e){var t=new glMatrixArrayType(16);if(e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15]}return t};mat4.set=function(e,t){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15];return t};mat4.identity=function(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e};mat4.transpose=function(e,t){if(!t||e==t){var n=e[1],r=e[2],i=e[3],s=e[6],o=e[7],u=e[11];e[1]=e[4];e[2]=e[8];e[3]=e[12];e[4]=n;e[6]=e[9];e[7]=e[13];e[8]=r;e[9]=s;e[11]=e[14];e[12]=i;e[13]=o;e[14]=u;return e}t[0]=e[0];t[1]=e[4];t[2]=e[8];t[3]=e[12];t[4]=e[1];t[5]=e[5];t[6]=e[9];t[7]=e[13];t[8]=e[2];t[9]=e[6];t[10]=e[10];t[11]=e[14];t[12]=e[3];t[13]=e[7];t[14]=e[11];t[15]=e[15];return t};mat4.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14];e=e[15];return p*l*u*i-f*d*u*i-p*o*c*i+s*d*c*i+f*o*v*i-s*l*v*i-p*l*r*a+f*d*r*a+p*n*c*a-t*d*c*a-f*n*v*a+t*l*v*a+p*o*r*h-s*d*r*h-p*n*u*h+t*d*u*h+s*n*v*h-t*o*v*h-f*o*r*e+s*l*r*e+f*n*u*e-t*l*u*e-s*n*c*e+t*o*c*e};mat4.inverse=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=e[9],h=e[10],p=e[11],d=e[12],v=e[13],m=e[14],g=e[15],y=n*u-r*o,b=n*a-i*o,w=n*f-s*o,E=r*a-i*u,S=r*f-s*u,x=i*f-s*a,T=l*v-c*d,N=l*m-h*d,C=l*g-p*d,k=c*m-h*v,L=c*g-p*v,A=h*g-p*m,O=1/(y*A-b*L+w*k+E*C-S*N+x*T);t[0]=(u*A-a*L+f*k)*O;t[1]=(-r*A+i*L-s*k)*O;t[2]=(v*x-m*S+g*E)*O;t[3]=(-c*x+h*S-p*E)*O;t[4]=(-o*A+a*C-f*N)*O;t[5]=(n*A-i*C+s*N)*O;t[6]=(-d*x+m*w-g*b)*O;t[7]=(l*x-h*w+p*b)*O;t[8]=(o*L-u*C+f*T)*O;t[9]=(-n*L+r*C-s*T)*O;t[10]=(d*S-v*w+g*y)*O;t[11]=(-l*S+c*w-p*y)*O;t[12]=(-o*k+u*N-a*T)*O;t[13]=(n*k-r*N+i*T)*O;t[14]=(-d*E+v*b-m*y)*O;t[15]=(l*E-c*b+h*y)*O;return t};mat4.toRotationMat=function(e,t){t||(t=mat4.create());t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t};mat4.toMat3=function(e,t){t||(t=mat3.create());t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[4];t[4]=e[5];t[5]=e[6];t[6]=e[8];t[7]=e[9];t[8]=e[10];return t};mat4.toInverseMat3=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[4],o=e[5],u=e[6],a=e[8],f=e[9],l=e[10],c=l*o-u*f,h=-l*s+u*a,p=f*s-o*a,d=n*c+r*h+i*p;if(!d)return null;d=1/d;t||(t=mat3.create());t[0]=c*d;t[1]=(-l*r+i*f)*d;t[2]=(u*r-i*o)*d;t[3]=h*d;t[4]=(l*n-i*a)*d;t[5]=(-u*n+i*s)*d;t[6]=p*d;t[7]=(-f*n+r*a)*d;t[8]=(o*n-r*s)*d;return t};mat4.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11],v=e[12],m=e[13],g=e[14];e=e[15];var y=t[0],b=t[1],w=t[2],E=t[3],S=t[4],x=t[5],T=t[6],N=t[7],C=t[8],k=t[9],L=t[10],A=t[11],O=t[12],M=t[13],_=t[14];t=t[15];n[0]=y*r+b*u+w*c+E*v;n[1]=y*i+b*a+w*h+E*m;n[2]=y*s+b*f+w*p+E*g;n[3]=y*o+b*l+w*d+E*e;n[4]=S*r+x*u+T*c+N*v;n[5]=S*i+x*a+T*h+N*m;n[6]=S*s+x*f+T*p+N*g;n[7]=S*o+x*l+T*d+N*e;n[8]=C*r+k*u+L*c+A*v;n[9]=C*i+k*a+L*h+A*m;n[10]=C*s+k*f+L*p+A*g;n[11]=C*o+k*l+L*d+A*e;n[12]=O*r+M*u+_*c+t*v;n[13]=O*i+M*a+_*h+t*m;n[14]=O*s+M*f+_*p+t*g;n[15]=O*o+M*l+_*d+t*e;return n};mat4.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1];t=t[2];n[0]=e[0]*r+e[4]*i+e[8]*t+e[12];n[1]=e[1]*r+e[5]*i+e[9]*t+e[13];n[2]=e[2]*r+e[6]*i+e[10]*t+e[14];return n};mat4.multiplyVec4=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];t=t[3];n[0]=e[0]*r+e[4]*i+e[8]*s+e[12]*t;n[1]=e[1]*r+e[5]*i+e[9]*s+e[13]*t;n[2]=e[2]*r+e[6]*i+e[10]*s+e[14]*t;n[3]=e[3]*r+e[7]*i+e[11]*s+e[15]*t;return n};mat4.translate=function(e,t,n){var r=t[0],i=t[1];t=t[2];if(!n||e==n){e[12]=e[0]*r+e[4]*i+e[8]*t+e[12];e[13]=e[1]*r+e[5]*i+e[9]*t+e[13];e[14]=e[2]*r+e[6]*i+e[10]*t+e[14];e[15]=e[3]*r+e[7]*i+e[11]*t+e[15];return e}var s=e[0],o=e[1],u=e[2],a=e[3],f=e[4],l=e[5],c=e[6],h=e[7],p=e[8],d=e[9],v=e[10],m=e[11];n[0]=s;n[1]=o;n[2]=u;n[3]=a;n[4]=f;n[5]=l;n[6]=c;n[7]=h;n[8]=p;n[9]=d;n[10]=v;n[11]=m;n[12]=s*r+f*i+p*t+e[12];n[13]=o*r+l*i+d*t+e[13];n[14]=u*r+c*i+v*t+e[14];n[15]=a*r+h*i+m*t+e[15];return n};mat4.scale=function(e,t,n){var r=t[0],i=t[1];t=t[2];if(!n||e==n){e[0]*=r;e[1]*=r;e[2]*=r;e[3]*=r;e[4]*=i;e[5]*=i;e[6]*=i;e[7]*=i;e[8]*=t;e[9]*=t;e[10]*=t;e[11]*=t;return e}n[0]=e[0]*r;n[1]=e[1]*r;n[2]=e[2]*r;n[3]=e[3]*r;n[4]=e[4]*i;n[5]=e[5]*i;n[6]=e[6]*i;n[7]=e[7]*i;n[8]=e[8]*t;n[9]=e[9]*t;n[10]=e[10]*t;n[11]=e[11]*t;n[12]=e[12];n[13]=e[13];n[14]=e[14];n[15]=e[15];return n};mat4.rotate=function(e,t,n,r){var i=n[0],s=n[1];n=n[2];var o=Math.sqrt(i*i+s*s+n*n);if(!o)return null;if(o!=1){o=1/o;i*=o;s*=o;n*=o}var u=Math.sin(t),a=Math.cos(t),f=1-a;t=e[0];o=e[1];var l=e[2],c=e[3],h=e[4],p=e[5],d=e[6],v=e[7],m=e[8],g=e[9],y=e[10],b=e[11],w=i*i*f+a,E=s*i*f+n*u,S=n*i*f-s*u,x=i*s*f-n*u,T=s*s*f+a,N=n*s*f+i*u,C=i*n*f+s*u;i=s*n*f-i*u;s=n*n*f+a;if(r){if(e!=r){r[12]=e[12];r[13]=e[13];r[14]=e[14];r[15]=e[15]}}else r=e;r[0]=t*w+h*E+m*S;r[1]=o*w+p*E+g*S;r[2]=l*w+d*E+y*S;r[3]=c*w+v*E+b*S;r[4]=t*x+h*T+m*N;r[5]=o*x+p*T+g*N;r[6]=l*x+d*T+y*N;r[7]=c*x+v*T+b*N;r[8]=t*C+h*i+m*s;r[9]=o*C+p*i+g*s;r[10]=l*C+d*i+y*s;r[11]=c*C+v*i+b*s;return r};mat4.rotateX=function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var i=e[4],s=e[5],o=e[6],u=e[7],a=e[8],f=e[9],l=e[10],c=e[11];if(n){if(e!=n){n[0]=e[0];n[1]=e[1];n[2]=e[2];n[3]=e[3];n[12]=e[12];n[13]=e[13];n[14]=e[14];n[15]=e[15]}}else n=e;n[4]=i*t+a*r;n[5]=s*t+f*r;n[6]=o*t+l*r;n[7]=u*t+c*r;n[8]=i*-r+a*t;n[9]=s*-r+f*t;n[10]=o*-r+l*t;n[11]=u*-r+c*t;return n};mat4.rotateY=function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var i=e[0],s=e[1],o=e[2],u=e[3],a=e[8],f=e[9],l=e[10],c=e[11];if(n){if(e!=n){n[4]=e[4];n[5]=e[5];n[6]=e[6];n[7]=e[7];n[12]=e[12];n[13]=e[13];n[14]=e[14];n[15]=e[15]}}else n=e;n[0]=i*t+a*-r;n[1]=s*t+f*-r;n[2]=o*t+l*-r;n[3]=u*t+c*-r;n[8]=i*r+a*t;n[9]=s*r+f*t;n[10]=o*r+l*t;n[11]=u*r+c*t;return n};mat4.rotateZ=function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var i=e[0],s=e[1],o=e[2],u=e[3],a=e[4],f=e[5],l=e[6],c=e[7];if(n){if(e!=n){n[8]=e[8];n[9]=e[9];n[10]=e[10];n[11]=e[11];n[12]=e[12];n[13]=e[13];n[14]=e[14];n[15]=e[15]}}else n=e;n[0]=i*t+a*r;n[1]=s*t+f*r;n[2]=o*t+l*r;n[3]=u*t+c*r;n[4]=i*-r+a*t;n[5]=s*-r+f*t;n[6]=o*-r+l*t;n[7]=u*-r+c*t;return n};mat4.frustum=function(e,t,n,r,i,s,o){o||(o=mat4.create());var u=t-e,a=r-n,f=s-i;o[0]=i*2/u;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=i*2/a;o[6]=0;o[7]=0;o[8]=(t+e)/u;o[9]=(r+n)/a;o[10]=-(s+i)/f;o[11]=-1;o[12]=0;o[13]=0;o[14]=-(s*i*2)/f;o[15]=0;return o};mat4.perspective=function(e,t,n,r,i){e=n*Math.tan(e*Math.PI/360);t=e*t;return mat4.frustum(-t,t,-e,e,n,r,i)};mat4.ortho=function(e,t,n,r,i,s,o){o||(o=mat4.create());var u=t-e,a=r-n,f=s-i;o[0]=2/u;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=2/a;o[6]=0;o[7]=0;o[8]=0;o[9]=0;o[10]=-2/f;o[11]=0;o[12]=-(e+t)/u;o[13]=-(r+n)/a;o[14]=-(s+i)/f;o[15]=1;return o};mat4.lookAt=function(e,t,n,r){r||(r=mat4.create());var i=e[0],s=e[1];e=e[2];var o=n[0],u=n[1],a=n[2];n=t[1];var f=t[2];if(i==t[0]&&s==n&&e==f)return mat4.identity(r);var l,c,h,p;n=i-t[0];f=s-t[1];t=e-t[2];p=1/Math.sqrt(n*n+f*f+t*t);n*=p;f*=p;t*=p;l=u*t-a*f;a=a*n-o*t;o=o*f-u*n;if(p=Math.sqrt(l*l+a*a+o*o)){p=1/p;l*=p;a*=p;o*=p}else o=a=l=0;u=f*o-t*a;c=t*l-n*o;h=n*a-f*l;if(p=Math.sqrt(u*u+c*c+h*h)){p=1/p;u*=p;c*=p;h*=p}else h=c=u=0;r[0]=l;r[1]=u;r[2]=n;r[3]=0;r[4]=a;r[5]=c;r[6]=f;r[7]=0;r[8]=o;r[9]=h;r[10]=t;r[11]=0;r[12]=-(l*i+a*s+o*e);r[13]=-(u*i+c*s+h*e);r[14]=-(n*i+f*s+t*e);r[15]=1;return r};mat4.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};quat4={};quat4.create=function(e){var t=new glMatrixArrayType(4);if(e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3]}return t};quat4.set=function(e,t){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];return t};quat4.calculateW=function(e,t){var n=e[0],r=e[1],i=e[2];if(!t||e==t){e[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i));return e}t[0]=n;t[1]=r;t[2]=i;t[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i));return t};quat4.inverse=function(e,t){if(!t||e==t){e[0]*=1;e[1]*=1;e[2]*=1;return e}t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];t[3]=e[3];return t};quat4.length=function(e){var t=e[0],n=e[1],r=e[2];e=e[3];return Math.sqrt(t*t+n*n+r*r+e*e)};quat4.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=Math.sqrt(n*n+r*r+i*i+s*s);if(o==0){t[0]=0;t[1]=0;t[2]=0;t[3]=0;return t}o=1/o;t[0]=n*o;t[1]=r*o;t[2]=i*o;t[3]=s*o;return t};quat4.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2];e=e[3];var o=t[0],u=t[1],a=t[2];t=t[3];n[0]=r*t+e*o+i*a-s*u;n[1]=i*t+e*u+s*o-r*a;n[2]=s*t+e*a+r*u-i*o;n[3]=e*t-r*o-i*u-s*a;return n};quat4.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];t=e[0];var o=e[1],u=e[2];e=e[3];var a=e*r+o*s-u*i,f=e*i+u*r-t*s,l=e*s+t*i-o*r;r=-t*r-o*i-u*s;n[0]=a*e+r*-t+f*-u-l*-o;n[1]=f*e+r*-o+l*-t-a*-u;n[2]=l*e+r*-u+a*-o-f*-t;return n};quat4.toMat3=function(e,t){t||(t=mat3.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u;n=n*a;var c=r*u;r=r*a;i=i*a;o=s*o;u=s*u;s=s*a;t[0]=1-(c+i);t[1]=l-s;t[2]=n+u;t[3]=l+s;t[4]=1-(f+i);t[5]=r-o;t[6]=n-u;t[7]=r+o;t[8]=1-(f+c);return t};quat4.toMat4=function(e,t){t||(t=mat4.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u;n=n*a;var c=r*u;r=r*a;i=i*a;o=s*o;u=s*u;s=s*a;t[0]=1-(c+i);t[1]=l-s;t[2]=n+u;t[3]=0;t[4]=l+s;t[5]=1-(f+i);t[6]=r-o;t[7]=0;t[8]=n-u;t[9]=r+o;t[10]=1-(f+c);t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t};quat4.slerp=function(e,t,n,r){r||(r=e);var i=n;if(e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]<0)i=-1*n;r[0]=1-n*e[0]+i*t[0];r[1]=1-n*e[1]+i*t[1];r[2]=1-n*e[2]+i*t[2];r[3]=1-n*e[3]+i*t[3];return r};quat4.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"};gl=null;glGlobals={};zogl={};zogl.rad=function(e){return e*Math.PI/180};zogl.deg=function(e){return e*180/Math.PI};zogl.getMousePosition=function(e){var t=glGlobals.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}};zogl.rect=function(e,t,n,r){this.x=e||0;this.y=t||0;this.w=n||0;this.h=r||0};zogl.rect.prototype.collideRect=function(e){var t=this.y,n=this.y+this.h,r=this.x+this.w,i=this.x;var s=e.y,o=e.y+e.h,u=e.x+e.w,a=e.x;if(n<=s||t>=o||r<=a||i>=u){return false}return true};zogl.rect.prototype.collidePosition=function(e,t){return this.collideRect(new zogl.rect(e,t,1,1))};zogl.color4=function(e){this.set(e)};zogl.color4.prototype.asHex=function(){return"#"+(this.r*255<<24^this.g*255<<16^this.b*255<<8^this.a*255).toString(16)};zogl.color4.prototype.asRGBA=function(){return[this.r*255,this.g*255,this.b*255,this.a*255]};zogl.color4.prototype.asGL=function(){return new Float32Array([this.r,this.g,this.b,this.a])};zogl.color4.prototype.set=function(){var e=arguments;if(arguments[0]instanceof Array){e=arguments[0]}if(e.length>=3){if(sum(e)<=4){this.r=e[0];this.g=e[1];this.b=e[2];this.a=e[3]||1}else{this.r=e[0]/255;this.g=e[1]/255;this.b=e[2]/255;this.a=e[3]/255||1}}else if(e.length==1&&typeof e[0]=="string"){if(e[0][0]=="#")e[0]=e[0].slice(1);var t=parseInt(e[0],16);this.r=(t>>16&255)/255;this.g=(t>>8&255)/255;this.b=(t&255)/255;this.a=1}else if(e.length==1&&e[0]instanceof zogl.color4){this.r=e[0].r;this.b=e[0].g;this.b=e[0].b;this.a=e[0].a||1}else{log("incompatible");throw"incompatible"}};zogl.onGLError=function(e,t,n){var r="";for(var i in n){r+=n[i]+", "}log('An error occured calling "gl.'+t+"("+r.slice(0,-2)+')": '+e)};zogl.init=function(e){try{gl=e.getContext("experimental-webgl");if(zogl.debug){gl=WebGLDebugUtils.makeDebugContext(gl,zogl.onGLError)}}catch(t){}if(!gl){alert("WebGL is not supported!");return false}gl.viewportWidth=e.width;gl.viewportHeight=e.height;gl.viewport(0,0,e.width,e.height);glGlobals.mv=mat4.create();glGlobals.proj=mat4.create();glGlobals.canvas=e;mat4.identity(glGlobals.mv);mat4.ortho(0,e.width,e.height,0,1,10,glGlobals.proj);glGlobals.canvas.oncontextmenu=function(e){e.preventDefault()};return true};zogl.loadScript=function(e,t){var n=document.createElement("script");n.type="text/javascript";n.src="js/"+e;n.onload=t;document.getElementsByTagName("head")[0].appendChild(n)};zogl=zogl||{};zogl.SHADERS={defaultvs:["attribute vec2 in_vert;","attribute vec4 in_color;","attribute vec2 in_texc;","uniform mat4 mv;","uniform mat4 proj;","varying vec2 vs_texc;","varying vec4 vs_color;","void main(void) {","gl_Position = proj * mv * vec4(in_vert, -1.0, 1.0);","vs_color = in_color;","vs_texc  = in_texc;","}"].join("\n"),defaultfs:["precision mediump float;","varying vec2 vs_texc;","varying vec4 vs_color;","uniform sampler2D texture;","void main(void) {","gl_FragColor = vs_color * texture2D(texture, vs_texc);","}"].join("\n"),pointLightFS:["precision mediump float;","varying vec2 vs_texc;","varying vec4 vs_color;","uniform sampler2D texture;","uniform int    scr_height;","uniform float  light_brt;","uniform vec2   light_pos;","uniform vec3   light_att;","uniform vec4   light_col;","void main(void) {","vec2 pixel      = gl_FragCoord.xy;","pixel.y         = float(scr_height) - pixel.y;","vec2 light_vec  = light_pos - pixel;","float dist      = length(light_vec);","float att       = 1.0 / ( light_att.x +","( light_att.y * dist) +","( light_att.z * dist * dist));","vec4 tmp        = texture2D(texture, vs_texc) *","                  light_col * vec4(att, att, att, 1.0);","gl_FragColor    = tmp * light_brt * vs_color;","}"].join("\n"),ambientLightFS:["precision mediump float;","varying vec2 vs_texc;","varying vec4 vs_color;","uniform vec4        light_col;","uniform float       light_brt;","uniform sampler2D   texture;","void main()","{","gl_FragColor   = light_brt * light_col;","gl_FragColor  *= vs_color * texture2D(texture, vs_texc);","}"].join("\n")};zogl=zogl||{};zogl.zTexture=function(){this.id=0;this.filename="";this.size={w:0,h:0};this.loaded=false;this.resetOnload()};zogl.zTexture.prototype.loadFromFile=function(e){this.loadFromRaw([255,255,255,255],false,1,1);this.filename=e;this.id.image=new Image;this.id.image.onload=this.callback;this.id.image.src=e};zogl.zTexture.prototype.loadFromRaw=function(e,t,n,r){this.filename=this.filename||"raw data";this.id=this.id||gl.createTexture();this.id.image=e;this.bind();if(t){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true)}if(n&&r){if(e instanceof Array)e=new Uint8Array(e);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,n,r,0,gl.RGBA,gl.UNSIGNED_BYTE,e);this.size.w=n;this.size.h=r}else{gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e);this.size.w=e.width;this.size.h=e.height}gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);this.unbind()};zogl.zTexture.prototype.bind=function(){gl.bindTexture(gl.TEXTURE_2D,this.id)};zogl.zTexture.prototype.unbind=function(){gl.bindTexture(gl.TEXTURE_2D,null)};zogl.zTexture.prototype.setOnload=function(e){if(this.loaded){e()}var t=this.callback;this.callback=function(){t();e()};if(this.id.image!==undefined){this.id.image.onload=this.callback()}};zogl.zTexture.prototype.resetOnload=function(){var e=this;this.callback=function(t){e.loadFromRaw(e.id.image,true);e.loaded=true}};zogl.zWindow=function(e,t){this.size={w:e||gl.viewportWidth,h:t||gl.viewportHeight};this.proj=mat4.create()};zogl.zWindow.prototype.init=function(){this.resize(this.size.w,this.size.h);glGlobals.activeWindow=this};zogl.zWindow.prototype.resize=function(e,t){this.size={w:e,h:t};glGlobals.canvas.width=e;glGlobals.canvas.height=t;gl.viewportWidth=e;gl.viewportHeight=t;gl.viewport(0,0,e,t);mat4.ortho(0,e,t,0,1,10,this.proj);glGlobals.proj=this.proj;this.refresh()};zogl.zWindow.prototype.refresh=function(){delete glGlobals.defaultShader;delete glGlobals.defaultTexture;s=new zogl.zShader;s.loadFromString(zogl.SHADERS.defaultvs,zogl.SHADERS.defaultfs);s.bind();s.setParameterMat("proj",glGlobals.proj);s.setParameterMat("mv",glGlobals.mv);t=new zogl.zTexture;t.loadFromRaw([255,255,255,255],false,1,1);glGlobals.defaultShader=s;glGlobals.defaultTexture=t};zogl.zWindow.prototype.clear=function(e){e=e||new zogl.color4("#000000");if(!(e instanceof zogl.color4)){var t=function(){};t.prototype=zogl.color4.prototype;var n=new t;e=zogl.color4.apply(n,arguments);if(!(Object(e)===e)){e=n}}gl.clearColor(e.r,e.g,e.b,e.a);gl.clear(gl.COLOR_BUFFER_BIT)};zogl.zWindow.prototype.loop=function(e){requestAnimationFrame(e)};zogl.zShader=function(){this.vs_fn="";this.fs_fn="";this.errorstr="";this.vs=null;this.fs=null;this.program=null;this.uniforms={};this.sources=zogl.debug?[]:undefined};zogl.zShader.prototype.loadFromString=function(e,t){this.vs=this.loadFromStr(e,gl.VERTEX_SHADER);this.fs=this.loadFromStr(t,gl.FRAGMENT_SHADER);if(!this.vs||!this.fs)return false;this.vs_fn="vs_fromstr";this.fs_fn="fs_fromstr";return this.createProgram()};zogl.zShader.prototype.loadFromNode=function(e,t){this.vs=this.loadFromID(e,gl.VERTEX_SHADER);this.fs=this.loadFromID(t,gl.FRAGMENT_SHADER);if(!this.vs||!this.fs)return false;this.vs_fn=e;this.fs_fn=t;return this.createProgram()};zogl.zShader.prototype.createProgram=function(){this.program=gl.createProgram();gl.attachShader(this.program,this.vs);gl.attachShader(this.program,this.fs);gl.linkProgram(this.program);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS)){this.errorstr="Error occured when linking shaders.";return false}return true};zogl.zShader.prototype.getParameterLocation=function(e){if(!(e in this.uniforms)){this.uniforms[e]=gl.getUniformLocation(this.program,e)}return this.uniforms[e]};zogl.zShader.prototype.getAttributeLocation=function(e){return gl.getAttribLocation(this.program,e)};zogl.zShader.prototype.loadFromStr=function(e,t){var n=gl.createShader(t);gl.shaderSource(n,e);gl.compileShader(n);if(!gl.getShaderParameter(n,gl.COMPILE_STATUS)){this.errorstr=gl.getShaderInfoLog(n);return null}if(zogl.debug){this.sources.push(e)}return n};zogl.zShader.prototype.loadFromID=function(e,t){var n=document.getElementById(e);if(!n)return null;var r="";var i=n.firstChild;while(i){if(i.nodeType==3){r+=i.textContent}i=i.nextSibling}return this.loadFromStr(r,t)};zogl.zShader.prototype.setParameterMat=function(e,t){gl.uniformMatrix4fv(this.getParameterLocation(e),false,t)};zogl.zShader.prototype.setParameterFl=function(e,t){var n=this.getParameterLocation(e);if(t===parseFloat(t)||t.length==1){gl.uniform1f(n,t);return}var r=null;if(t.length==2){r=gl.uniform2fv}else if(t.length==3){r=gl.uniform3fv}else if(t.length==4){r=gl.uniform4fv}else{throw"invalid number of parameters";return}r(n,t)};zogl.zShader.prototype.setParameterInt=function(e,t){if(t===parseInt(t)||t.length==1){gl.uniform1i(this.getParameterLocation(e),t);return}var n=null;if(t.length==2){n=gl.uniform2iv}else if(t.length==3){n=gl.uniform3iv}else if(t.length==4){n=gl.uniform4iv}else{throw"invalid number of parameters";return}n(this.getParameterLocation(e),t)};zogl.zShader.prototype.setTexture=function(e,t){gl.activeTexture(gl.TEXTURE0+t);gl.uniform1i(this.getParameterLocation(e),t)};zogl.zShader.prototype.bind=function(){gl.useProgram(this.program);glGlobals.activeShader=this};zogl.zShader.prototype.unbind=function(){gl.useProgram(null);glGlobals.activeShader=glGlobals.defaultShader};zogl=zogl||{};zogl.zBuffer=function(e,t,n){this.bufferType=e;this.drawType=t||gl.STATIC_DRAW;this.attribute=null;this.size=0;this.itemSize=0;this.dataType=n||Float32Array;this.data=null;this.buffer=gl.createBuffer()};zogl.zBuffer.prototype.addData=function(e,t){if(this.size){throw".offload() has been called, you can no longer add data to this buffer.";return false}var n=this.data==null?0:this.data.length;if(this.data){var r=new this.dataType(this.data.length+e.length);for(var i in this.data){r[i]=this.data[i]}for(var i in e){r[parseInt(i)+n]=e[i]}this.data=r}else{this.data=e}this.itemSize=t;return n};zogl.zBuffer.prototype.offload=function(){if(!this.data||!this.data.length)return;this.bind();gl.bufferData(this.bufferType,this.data,this.drawType);this.size=this.data.length;this.data=null;this.unbind()};zogl.zBuffer.prototype.setAttribute=function(e){this.attribute=glGlobals.activeShader.getAttributeLocation(e)};zogl.zBuffer.prototype.bind=function(){gl.bindBuffer(this.bufferType,this.buffer)};zogl.zBuffer.prototype.unbind=function(){gl.bindBuffer(this.bufferType,null)};zogl.zBuffer.prototype.prepare=function(){this.bind();if(this.attribute!==null){gl.enableVertexAttribArray(this.attribute);gl.vertexAttribPointer(this.attribute,this.itemSize,gl.FLOAT,false,0,0)}};zogl.zBufferSet=function(e){this.buffers={};this.type=e||gl.STATIC_DRAW};zogl.zBufferSet.prototype.addData=function(e){this.addPositions(e.positions);var t=this.addIndices(e.indices);this.addColors(e.colors);this.addTexCoords(e.texcoords);return t};zogl.zBufferSet.prototype.addPositions=function(e){if(!e||!e.length)return;if(!("positions"in this.buffers)){this.buffers.positions=new zogl.zBuffer(gl.ARRAY_BUFFER,this.type)}var t=this.buffers.positions.addData(e,2);this.buffers.positions.setAttribute("in_vert");return t};zogl.zBufferSet.prototype.addIndices=function(e){if(!e||!e.length)return;if(!("posIndex"in this.buffers)){this.buffers.posIndex=new zogl.zBuffer(gl.ELEMENT_ARRAY_BUFFER,this.type,Uint16Array)}return this.buffers.posIndex.addData(e,1)};zogl.zBufferSet.prototype.addColors=function(e){if(!e||!e.length)return;if(!("colors"in this.buffers)){this.buffers.colors=new zogl.zBuffer(gl.ARRAY_BUFFER,this.type)}var t=this.buffers.colors.addData(e,4);this.buffers.colors.setAttribute("in_color");return t};zogl.zBufferSet.prototype.addTexCoords=function(e){if(!e||!e.length)return;if(!("texcoords"in this.buffers)){this.buffers.texcoords=new zogl.zBuffer(gl.ARRAY_BUFFER,this.type)}var t=this.buffers.texcoords.addData(e,2);this.buffers.texcoords.setAttribute("in_texc");return t};zogl.zBufferSet.prototype.bind=function(){for(var e in this.buffers){this.buffers[e].prepare()}};zogl.zBufferSet.prototype.unbind=function(){gl.bindBuffer(gl.ARRAY_BUFFER,null);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)};zogl.zBufferSet.prototype.draw=function(){for(var e in this.buffers){this.buffers[e].offload();this.buffers[e].prepare()}if("posIndex"in this.buffers){gl.drawElements(gl.TRIANGLES,this.buffers.posIndex.size,gl.UNSIGNED_SHORT,0)}else if("positions"in this.buffers){gl.drawArrays(gl.TRIANGLES,0,this.buffers.positions.size/this.buffers.positions.numItems)}this.unbind()};zogl.zBufferSet.prototype.offload=function(){for(var e in this.buffers){this.buffers[e].offload()}};zogl.zPolygon=function(){this.vao=null;this.internal=false;this.mv=mat4.create();mat4.identity(this.mv);this.drawData={positions:[],indices:[],colors:[],texcoords:[]};this.verts=[];this.color=new zogl.color4("#FFFFFF");this.x=0;this.y=0;this.shader=glGlobals.defaultShader;this.texture=glGlobals.defaultTexture;this.size={w:0,h:0}};zogl.zPolygon.prototype.clone=function(){var e=new this.constructor;e.drawData={positions:new Float32Array(this.drawData.positions),indices:new Uint16Array(this.drawData.indices),colors:new Float32Array(this.drawData.colors),texcoords:new Float32Array(this.drawData.texcoords),icount:this.drawData.icount||0,vcount:this.drawData.vcount||0};e.x=this.x;e.y=this.y;e.shader=this.shader;e.texture=this.texture;e.verts=this.verts.slice(0);e.color=new zogl.color4(this.color);e.offset=0;e.size={w:this.calcWidth(),h:this.calcHeight()};mat4.translate(e.mv,[e.x,e.y,0]);return e};zogl.zPolygon.prototype.move=function(e,t){this.x=e;this.y=t};zogl.zPolygon.prototype.addVertex=function(e,t){this.verts.push(e);this.verts.push(t);this.size={w:this.calcWidth(),h:this.calcHeight()}};zogl.zPolygon.prototype.create=function(){if(this.verts.length<=2)return false;if(!this.drawData.indices.length){var e=(this.verts.length/2-2)*3;var t=new Uint16Array(e);for(var n=0;n<e;n+=3){var r=n/3;t[n]=0;t[n+1]=r+1;t[n+2]=r+2}this.drawData.indices=t;this.drawData.icount=t.length}this.drawData.texcoords=new Float32Array(this.verts.length);this.drawData.positions=new Float32Array(this.verts.length);this.drawData.colors=new Float32Array(2*this.verts.length);for(var n in this.verts){this.drawData.colors[n*4]=this.color.r;this.drawData.colors[n*4+1]=this.color.g;this.drawData.colors[n*4+2]=this.color.b;this.drawData.colors[n*4+3]=this.color.a;this.drawData.positions[n]=this.verts[n];this.drawData.texcoords[n]=0}this.drawData.vcount=this.verts.length;this.verts=[];return true};zogl.zPolygon.prototype.draw=function(e,t){var e=e||false;if(!e){if(this.vao===null){this.vao=new zogl.zBufferSet;this.offset=this.vao.addData(this.drawData);this.vao.offload();this.internal=true}this.vao.bind();this.prepareMaterial();if(t!==undefined){t.bind()}}mat4.identity(this.mv);mat4.translate(this.mv,[this.x,this.y,0]);glGlobals.activeShader.setParameterMat("mv",this.mv);glGlobals.activeShader.setParameterMat("proj",glGlobals.proj);gl.drawElements(gl.TRIANGLES,this.drawData.icount,gl.UNSIGNED_SHORT,this.offset)};zogl.zPolygon.prototype.setColor=function(e){this.color.set.apply(this.color,arguments)};zogl.zPolygon.prototype.getX=function(){return this.x};zogl.zPolygon.prototype.getY=function(){return this.y};zogl.zPolygon.prototype.offload=function(e,t){if(this.drawData.positions.length==0){return}this.offset=e.addData(this.drawData);this.vao=e;if(t&&t.preserve==false){delete this.drawData.positions;delete this.drawData.indices;delete this.drawData.colors;delete this.drawData.texcoords;this.drawData.positions=this.drawData.indices=this.drawData.colors=this.drawData.texcoords=[]}};zogl.zPolygon.prototype.prepareMaterial=function(){this.getShader().bind();this.texture.bind()};zogl.zPolygon.prototype.getShader=function(){return this.shader};zogl.zPolygon.prototype.setShader=function(e){this.shader=e};zogl.zPolygon.setColor=function(e){this.color=new color4(e)};zogl.zPolygon.prototype.getTexture=function(){return this.texture};zogl.zPolygon.prototype.calcWidth=function(){var e=this.verts.length==0?this.drawData.positions:this.verts;var t=0;for(var n=0;n<e.length;n+=2){t=Math.max(t,e[n])}this.size.w=t;return t};zogl.zPolygon.prototype.calcHeight=function(){var e=this.verts.length==0?this.drawData.positions:this.verts;var t=0;for(var n=0;n<e.length;n+=2){t=Math.max(t,e[n])}this.size.h=t;return t};zogl.zQuad=function(e,t){zogl.zPolygon.call(this);this.resize(e,t)};zogl.zQuad.prototype=new zogl.zPolygon;zogl.zQuad.prototype.constructor=zogl.zQuad;zogl.zQuad.prototype.create=function(){this.loadVerts();this.loadTexCoords();this.drawData.colors=new Float32Array(this.drawData.positions.length*2);for(var e in this.drawData.positions){this.drawData.colors[e*4]=this.color.r;this.drawData.colors[e*4+1]=this.color.g;this.drawData.colors[e*4+2]=this.color.b;this.drawData.colors[e*4+3]=this.color.a}this.drawData.indices=new Uint16Array([0,1,3,3,1,2]);this.drawData.icount=6;this.drawData.vcount=this.drawData.positions.length};zogl.zQuad.prototype.resize=function(e,t){this.size.w=e;this.size.h=t;if(this.drawData.positions.length>0&&this.verts.length>0){this.create()}};zogl.zQuad.prototype.loadVerts=function(){this.drawData.positions=new Float32Array([0,0,this.size.w,0,this.size.w,this.size.h,0,this.size.h])};zogl.zQuad.prototype.loadTexCoords=function(){this.drawData.texcoords=new Float32Array([0,1,1,1,1,0,0,0])};zogl.zQuad.prototype.attachTexture=function(e){this.texture=e;this.setColor("#FFFFFF");if(!this.size.w||!this.size.h){this.resize(e.size.w,e.size.h)}};zogl.zSprite=function(){this.rect=new zogl.rect;this.prims=[];this.passes=[];this.mv=mat4.create();this.flags={blend:false};mat4.identity(this.mv)};zogl.zSprite.prototype.loadFromTexture=function(e){if(typeof e=="string"){var t=e;e=new zogl.zTexture;e.loadFromFile(t)}this.rect.w=e.size.w;this.rect.h=e.size.h;var n=new zogl.zQuad(this.rect.w,this.rect.h);var r=this;e.setOnload(function(){n.resize(e.size.w,e.size.h);n.attachTexture(e);n.create();r.prims=[];r.addObject(n,0,0)})};zogl.zSprite.prototype.addObject=function(e,t,n){var r=e.clone();r.move(t||0,n||0);this.prims.push(r);this.rect.w=Math.max(this.rect.w,e.calcWidth()+(t||0));this.rect.h=Math.max(this.rect.h,e.calcHeight()+(n||0))};zogl.zSprite.prototype.move=function(e,t){mat4.translate(this.mv,vec3.create(e,t,0));this.rect.x=e;this.rect.y=t};zogl.zSprite.prototype.adjust=function(e,t){this.move(this.rect.x+e,this.rect.y+t)};zogl.zSprite.prototype.addPass=function(e){this.passes.push(e)};zogl.zSprite.prototype.draw=function(e){if(this.passes.length==0){this._drawPrims(e);return}var t=true;if(this.passes.length==1){for(var n in this.prims){if(this.prims[n].getShader()==undefined||this.prims[n].getShader()==glGlobals.defaultShader||this.prims[n].getShader()==this.passes[0]){this.prims[n].setShader(this.passes[0]);t=false}else{t=true;break}}}if(!t){this._drawPrims(e);return}var r=0,i=0;for(var n in this.prims){var s=this.prims[n].size.w+this.prims[n].getX();var o=this.prims[n].size.h+this.prims[n].getY();r=r>s?r:s;i=i>o?i:o}var u=glGlobals.activeRenderTarget;var a=new zogl.zRenderTarget(r,i),f=null;var l=a;if(this.passes.length>1){f=new zogl.zRenderTarget(r,i)}a.bind();this._drawPrims(e);var c=a.texture;var h=new zogl.zQuad(r,i);h.create();for(var p in this.passes){var d=!((p&1)==0);if(p+1<this.passes.length){if(d)f.bind();else a.bind()}else{glGlobals.activeRenderTarget.unbind();if(u){u.bind()}}h.attachTexture(c);h.draw(false,this.passes[p]);c=d?f.texture:a.texture}};zogl.zSprite.prototype.offload=function(e,t){for(var n in this.prims){this.prims[n].offload(e,t)}};zogl.zSprite.prototype._drawPrims=function(e,t){for(var n in this.prims){var r=[this.prims[n].getX(),this.prims[n].getY()];if(this.flags.blend){gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)}this.prims[n].move(this.getX()+r[0],this.getY()+r[1]);if(t!==undefined){t.bind();this.prims[n].getTexture().bind()}else if(e){this.prims[n].prepareMaterial()}this.prims[n].draw(e,t);this.prims[n].move(r[0],r[1]);if(this.flags.blend&&!this.prims[n+1]){gl.disable(gl.BLEND)}}};zogl.zSprite.prototype.collides=function(e,t){if(e.constructor==zogl.rect){return this.rect.collideRect(e)}else if(e.constructor==zogl.zSprite){log("spr");return this.rect.collideRect(e.rect)}return this.rect.collidePosition(e,t)};zogl.zSprite.prototype.getX=function(){return this.rect.x};zogl.zSprite.prototype.getY=function(){return this.rect.y};zogl=zogl||{};zogl.zFont=function(){this.size=0;this.filename="";this.node=null};zogl.zFont.prototype.loadFromFile=function(e,t){this.filename=e;this.size=t;this.node=document.createElement("canvas");this.node.id="font-"+e;this.node.style.display="none";this.node.context=this.node.getContext("2d");this.node.context.font=t+"px "+this.filename;document.body.appendChild(this.node)};zogl.zFont.prototype.draw=function(e){this.node.width=this.node.context.measureText(e).width;this.node.height=this.size*2;this.node.context.font=this.size+"px "+this.filename;this.node.context.fillText(e,0,this.size);var t=new zogl.zTexture;t.loadFromRaw(this.node,true);return t};zogl.zFont.prototype.drawOnSprite=function(e,t,n,r){var i=this.draw(e);var s=t.prims;t.loadFromTexture(i);t.prims[0].move(n||0,r||0);for(var o in s){t.addObject(s[o],s[o].getX(),s[o].getY())}};zogl.zRenderTarget=function(e,t){this.fbo=gl.createFramebuffer();this.rbo=gl.createRenderbuffer();this.texture=new zogl.zTexture;this.size={w:e||glGlobals.activeWindow.size.w,h:t||glGlobals.activeWindow.size.h};this.proj=mat4.create();mat4.ortho(0,this.size.w,this.size.h,0,1,10,this.proj);this.bind();this.texture.loadFromRaw(null,false,this.size.w,this.size.h);this.texture.bind();gl.bindRenderbuffer(gl.RENDERBUFFER,this.rbo);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.size.w,this.size.h);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture.id,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.rbo);this.texture.unbind();gl.bindRenderbuffer(gl.RENDERBUFFER,null);this.unbind()};zogl.zRenderTarget.prototype.clear=function(e){e=new zogl.color4(e||"#000000");gl.clearColor(e.r,e.g,e.b,e.a);gl.clear(gl.COLOR_BUFFER_BIT)};zogl.zRenderTarget.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo);gl.viewport(0,0,this.size.w,this.size.h);glGlobals.proj=this.proj;glGlobals.activeRenderTarget=this};zogl.zRenderTarget.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,glGlobals.activeWindow.size.w,glGlobals.activeWindow.size.h);glGlobals.proj=glGlobals.activeWindow.proj;glGlobals.activeRenderTarget=null};zogl.LightType={NO_LIGHT:-1,AMBIENT:0,POINT:1,SPOT:2};zogl.DefaultLightingConfig={attenuation:new Float32Array([.05,.01,0]),brightness:1,max_angle:45,min_angle:-45,color:(new zogl.color4("#FFFFFF")).asGL(),position:new Float32Array([0,0])};zogl.zLight=function(e,t){t=t||zogl.DefaultLightingConfig;this.type=e||zogl.LightType.AMBIENT;this.config={brightness:t.brightness||zogl.DefaultLightingConfig.brightness,attenuation:t.attenuation||zogl.DefaultLightingConfig.attenuation,position:t.position||zogl.DefaultLightingConfig.position,color:t.color||zogl.DefaultLightingConfig.color,max_angle:t.max_angle||zogl.DefaultLightingConfig.max_angle,min_angle:t.min_angle||zogl.DefaultLightingConfig.min_angle};var n=zogl.SHADERS.defaultfs;if(this.type==zogl.LightType.AMBIENT){n=zogl.SHADERS.ambientLightFS}else if(this.type==zogl.LightType.POINT){n=zogl.SHADERS.pointLightFS}else if(this.type==zogl.LightType.SPOT){n=zogl.SHADERS.spotLightFS}this.shader=new zogl.zShader;this.shader.loadFromString(zogl.SHADERS.defaultvs,n);log("Shader errors:",this.shader.errorstr);this.update()};zogl.zLight.prototype.setBrightness=function(e){this.config.brightness=e};zogl.zLight.prototype.setColor=function(e){this.config.color=typeof e=="Object"?e.asGL():(new zogl.color4(e)).asGL()};zogl.zLight.prototype.setAttenuation=function(e,t,n){this.config.attenuation=new Float32Array([e,t,n])};zogl.zLight.prototype.setPosition=function(e,t){this.config.position=new Float32Array([e,t])};zogl.zLight.prototype.setMaxAngle=function(e){this.config.max_angle=zogl.rad(e)};zogl.zLight.prototype.setMinAngle=function(e){this.config.max_angle=zogl.rad(e)};zogl.zLight.prototype.update=function(){this.enable();this.shader.setParameterFl("light_col",this.config.color);this.shader.setParameterFl("light_pos",this.config.position);this.shader.setParameterFl("light_att",this.config.attenuation);this.shader.setParameterFl("light_brt",this.config.brightness);this.shader.setParameterFl("light_max",this.config.max_angle);this.shader.setParameterFl("light_min",this.config.min_angle);this.shader.setParameterInt("scr_height",glGlobals.activeWindow.size.h);this.disable()};zogl.zLight.prototype.enable=function(){var e=mat4.create();mat4.identity(e);this.shader.bind();this.shader.setParameterMat("mv",e);this.shader.setParameterMat("proj",glGlobals.proj)};zogl.zLight.prototype.disable=function(){this.shader.unbind()};zogl.zScene=function(e,t,n){n=n||{};this.size={w:e||glGlobals.activeWindow.size.w,h:t||glGlobals.activeWindow.size.h};this.geometryVAO=new zogl.zBufferSet(gl.DYNAMIC_DRAW);this.fbo1=new zogl.zRenderTarget;this.fbo2=new zogl.zRenderTarget;this.lights=[];this.postfx=[];this.objects=[];this.fullscreen=new zogl.zBufferSet;this.fullscreen.addPositions(new Float32Array([0,0,this.size.w,0,this.size.w,this.size.h,0,this.size.h]));this.fullscreen.addIndices(new Uint16Array([0,1,3,3,1,2]));this.fullscreen.addColors(new Float32Array([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]));this.fullscreen.addTexCoords(new Float32Array([0,1,1,1,1,0,0,0]));this.fullscreen.offload();this.flags={lighting:n.lighting||false,postProcessing:n.postprocessing||false,blendThrough:n.blendThrough||false}};zogl.zScene.prototype.draw=function(e){var e=new zogl.color4(e||[.1,.1,.1,1]);if(this.flags.blendThrough){e.a=0}this.fbo2.bind();this.fbo2.clear(e);this.fbo1.bind();this.fbo1.clear(e);glGlobals.defaultShader.bind();for(var t in this.objects){this.objects[t].offload(this.geometryVAO,{preserve:false})}this.geometryVAO.offload();this.geometryVAO.bind();for(var t in this.objects){this.objects[t].draw(true)}var n=this.fbo1.texture;if(this.flags.lighting){this.fbo2.bind();n.bind();gl.blendFunc(gl.ONE,gl.ONE);for(var t in this.lights){this.lights[t].enable();this.fullscreen.draw();this.lights[t].disable()}n=this.fbo2.texture;gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)}this.fbo1.unbind();var r=mat4.create();mat4.identity(r);n.bind();glGlobals.defaultShader.bind();glGlobals.defaultShader.setParameterMat("proj",this.fbo1.proj);glGlobals.defaultShader.setParameterMat("mv",r);this.fullscreen.draw();n.unbind();glGlobals.defaultShader.unbind()};zogl.zScene.prototype.addObject=function(e,t){e=e||zogl.zSprite;var n=new e(t);this.objects.push(n);return n};zogl.zScene.prototype.addLight=function(e){var t=new zogl.zLight(e);this.lights.push(t);return t}